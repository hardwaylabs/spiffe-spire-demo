# ClusterSPIFFEID resources for automatic workload registration
# These CRDs tell SPIRE which SPIFFE IDs to assign based on pod selectors
---
apiVersion: spire.spiffe.io/v1alpha1
kind: ClusterSPIFFEID
metadata:
  name: spiffe-demo-web-dashboard
spec:
  spiffeIDTemplate: "spiffe://demo.example.com/ns/{{ .PodMeta.Namespace }}/sa/{{ .PodSpec.ServiceAccountName }}/web-dashboard"
  podSelector:
    matchLabels:
      app: web-dashboard
  namespaceSelector:
    matchLabels:
      kubernetes.io/metadata.name: spiffe-demo
---
apiVersion: spire.spiffe.io/v1alpha1
kind: ClusterSPIFFEID
metadata:
  name: spiffe-demo-user-service
spec:
  spiffeIDTemplate: "spiffe://demo.example.com/ns/{{ .PodMeta.Namespace }}/sa/{{ .PodSpec.ServiceAccountName }}/user-service"
  podSelector:
    matchLabels:
      app: user-service
  namespaceSelector:
    matchLabels:
      kubernetes.io/metadata.name: spiffe-demo
---
apiVersion: spire.spiffe.io/v1alpha1
kind: ClusterSPIFFEID
metadata:
  name: spiffe-demo-agent-service
spec:
  spiffeIDTemplate: "spiffe://demo.example.com/ns/{{ .PodMeta.Namespace }}/sa/{{ .PodSpec.ServiceAccountName }}/agent-service"
  podSelector:
    matchLabels:
      app: agent-service
  namespaceSelector:
    matchLabels:
      kubernetes.io/metadata.name: spiffe-demo
---
apiVersion: spire.spiffe.io/v1alpha1
kind: ClusterSPIFFEID
metadata:
  name: spiffe-demo-document-service
spec:
  spiffeIDTemplate: "spiffe://demo.example.com/ns/{{ .PodMeta.Namespace }}/sa/{{ .PodSpec.ServiceAccountName }}/document-service"
  podSelector:
    matchLabels:
      app: document-service
  namespaceSelector:
    matchLabels:
      kubernetes.io/metadata.name: spiffe-demo
---
apiVersion: spire.spiffe.io/v1alpha1
kind: ClusterSPIFFEID
metadata:
  name: spiffe-demo-opa-service
spec:
  spiffeIDTemplate: "spiffe://demo.example.com/ns/{{ .PodMeta.Namespace }}/sa/{{ .PodSpec.ServiceAccountName }}/opa-service"
  podSelector:
    matchLabels:
      app: opa-service
  namespaceSelector:
    matchLabels:
      kubernetes.io/metadata.name: spiffe-demo
